# Code Review Plugin

使用多个专业代理对拉取请求进行自动化代码审查，通过基于置信度的评分过滤误报。

## 概述

Code Review Plugin 通过并行启动多个代理来独立审查变更，实现拉取请求的自动化审查。它使用置信度评分来过滤误报，确保只发布高质量、可执行的反馈。

## 命令

### `/code-review`

使用多个专业代理对拉取请求执行自动化代码审查。

**功能：**
1. 检查是否需要审查（跳过已关闭、草稿、微不足道或已审查过的 PR）
2. 从仓库收集相关的 CLAUDE.md 指导文件
3. 总结拉取请求的变更
4. 启动 4 个并行代理独立审查：
   - **代理 #1 & #2**：审查是否符合 CLAUDE.md
   - **代理 #3**：扫描变更中的明显错误
   - **代理 #4**：通过 git blame/history 分析基于上下文的问题
5. 为每个问题评分 0-100 表示置信度
6. 过滤掉置信度低于 80 阈值的问题
7. 仅发布高置信度问题的审查评论

**用法：**
```bash
/code-review
```

**示例工作流程：**
```bash
# 在 PR 分支上，运行：
/code-review

# Claude 将：
# - 并行启动 4 个审查代理
# - 为每个问题评分置信度
# - 发布置信度 ≥80 的问题评论
# - 如果未发现高置信度问题则跳过发布
```

**功能特点：**
- 多个独立代理进行全面审查
- 基于置信度的评分减少误报（阈值：80）
- CLAUDE.md 合规性检查，包含明确的指导验证
- 仅关注变更中的错误检测（非现有问题）
- 通过 git blame 进行历史上下文分析
- 自动跳过已关闭、草稿或已审查过的 PR
- 直接链接到代码，包含完整 SHA 和行范围

**审查评论格式：**
```markdown
## Code review

发现 3 个问题：

1. OAuth 回调缺少错误处理（CLAUDE.md 规定"Always handle OAuth errors"）

https://github.com/owner/repo/blob/abc123.../src/auth.ts#L67-L72

2. 内存泄漏：OAuth 状态未清理（由于 finally 块缺少清理导致的错误）

https://github.com/owner/repo/blob/abc123.../src/auth.ts#L88-L95

3. 命名模式不一致（src/conventions/CLAUDE.md 规定"Use camelCase for functions"）

https://github.com/owner/repo/blob/abc123.../src/utils.ts#L23-L28
```

**置信度评分：**
- **0**：不确信，误报
- **25**：有些确信，可能是真的
- **50**：中等确信，确实存在但次要
- **75**：高度确信，确实存在且重要
- **100**：绝对确信，肯定是真的

**过滤的误报：**
- PR 中未引入的现有问题
- 看起来像错误但实际上不是的代码
- 吹毛求疵的挑剔问题
- linter 会捕获的问题
- 一般质量问题（除非在 CLAUDE.md 中）
- 有 lint 忽略注释的问题

## 安装

此插件包含在 Claude Code 仓库中。使用 Claude Code 时该命令自动可用。

## 最佳实践

### 使用 `/code-review`
- 维护清晰的 CLAUDE.md 文件以更好地检查合规性
- 信任 80+ 置信度阈值 - 误报已被过滤
- 对所有非微不足道的拉取请求运行
- 将代理发现作为人工审查的起点
- 根据重复的审查模式更新 CLAUDE.md

### 何时使用
- 所有有意义的变更的拉取请求
- 涉及关键代码路径的 PR
- 来自多个贡献者的 PR
- 指导合规性重要的 PR

### 何时不使用
- 已关闭或草稿 PR（自动跳过）
- 微不足道的自动 PR（自动跳过）
- 需要立即合并的紧急热修复
- 已审查过的 PR（自动跳过）

## 工作流集成

### 标准 PR 审查工作流：
```bash
# 创建带有变更的 PR
/code-review

# 审查自动化反馈
# 进行必要的修复
# 准备好时合并
```

### 作为 CI/CD 的一部分：
```bash
# 在 PR 创建或更新时触发
# 自动发布审查评论
# 如果审查已存在则跳过
```

## 要求

- 具有 GitHub 集成的 Git 仓库
- 已安装并认证的 GitHub CLI (`gh`)
- CLAUDE.md 文件（可选但推荐用于指导检查）

## 故障排除

### 审查耗时过长

**问题**：大型 PR 上代理速度慢

**解决方案**：
- 大型变更属正常情况 - 代理并行运行
- 4 个独立代理确保全面性
- 考虑将大型 PR 拆分为较小的 PR

### 误报过多

**问题**：审查标记了不真实的问题

**解决方案**：
- 默认阈值为 80（已过滤大部分误报）
- 让 CLAUDE.md 更具体地说明重要的内容
- 考虑标记的问题是否确实有效

### 未发布审查评论

**问题**：`/code-review` 运行但没有评论出现

**解决方案**：
检查是否：
- PR 已关闭（跳过审查）
- PR 是草稿（跳过审查）
- PR 微不足道/自动（跳过审查）
- PR 已有审查（跳过审查）
- 没有问题评分 ≥80（无需评论）

### 链接格式损坏

**问题**：代码链接在 GitHub 中无法正确渲染

**解决方案**：
链接必须遵循此确切格式：
```
https://github.com/owner/repo/blob/[full-sha]/path/file.ext#L[start]-L[end]
```
- 必须使用完整 SHA（非缩写）
- 必须使用 `#L` 表示法
- 必须包含包含至少 1 行上下文的行范围

### GitHub CLI 不工作

**问题**：`gh` 命令失败

**解决方案**：
- 安装 GitHub CLI：`brew install gh` (macOS) 或参阅 [GitHub CLI 安装](https://cli.github.com/)
- 认证：`gh auth login`
- 验证仓库有 GitHub 远程仓库

## 技巧

- **编写具体的 CLAUDE.md 文件**：清晰的指导 = 更好的审查
- **在 PR 中包含上下文**：帮助代理理解意图
- **使用置信度评分**：问题 ≥80 通常正确
- **迭代指导**：根据模式更新 CLAUDE.md
- **自动审查**：设置为 PR 工作流的一部分
- **信任过滤**：阈值防止噪音

## 配置

### 调整置信度阈值

默认阈值为 80。要调整，修改 `commands/code-review.md` 中的命令文件：
```markdown
过滤掉评分低于 80 的任何问题。
````

将 `80` 更改为您首选的阈值（0-100）。

### 自定义审查重点

编辑 `commands/code-review.md` 添加或修改代理任务：
- 添加安全专注的代理
- 添加性能分析代理
- 添加可访问性检查代理
- 添加文档质量检查

## 技术细节

### 代理架构
- **2x CLAUDE.md 合规代理**：指导检查的冗余
- **1x 错误检测器**：仅专注于变更中的明显错误
- **1x 历史分析器**：来自 git blame 和历史的上下文
- **Nx 置信度评分器**：每个问题一个，用于独立评分

### 评分系统
- 每个问题独立评分 0-100
- 评分考虑证据强度和验证
- 阈值（默认 80）过滤低置信度问题
- 对于 CLAUDE.md 问题：验证指导明确提及它

### GitHub 集成
使用 `gh` CLI 进行：
- 查看 PR 详细信息和差异
- 获取仓库数据
- 读取 git blame 和历史
- 发布审查评论

## 作者

Boris Cherny (boris@anthropic.com)

## 版本

1.0.0
