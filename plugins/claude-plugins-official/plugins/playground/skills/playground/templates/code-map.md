# 代码地图模板

当 playground 是关于可视化代码库架构时使用此模板：组件关系、数据流、层级图、带有交互式评论功能的系统架构，用于提供反馈。

## 布局

```
+-------------------+----------------------------------+
|                   |                                  |
|  控件:            |  SVG 画布                         |
|  • 视图预设       |  (节点 + 连接)                    |
|  • 图层切换       |  带有缩放控件                     |
|  • 连接           |                                  |
|    类型过滤器     |                                  |
|                   |  图例 (左下角)                    |
|  评论 (n):        +----------------------------------+
|  • 用户评论列表   |  提示词输出                       |
|    带有删除按钮   |  [ 复制提示词 ]                   |
+-------------------+----------------------------------+
```

代码地图 playground 使用 SVG 画布来绘制架构图。用户点击组件以添加评论，这些评论将成为生成提示词的一部分。图层和连接过滤器让用户可以专注于系统的特定部分。

## 代码地图的控件类型

| 决策 | 控件 | 示例 |
|---|---|---|
| 系统视图 | 预设按钮 | 完整系统、聊天流、数据流、代理系统 |
| 可见图层 | 复选框 | 客户端、服务器、SDK、数据、外部 |
| 连接类型 | 带颜色指示器的复选框 | 数据流（蓝色）、工具调用（绿色）、事件（红色） |
| 组件反馈 | 点击评论模态框 | 打开带有文本区域的模态框用于反馈 |
| 缩放级别 | +/−/重置按钮 | 缩放 SVG 以显示细节 |

## 画布渲染

使用 `<svg>` 元素和动态生成的节点和路径。关键模式：

- **节点：** 带有标题和副标题（文件路径）的圆角矩形
- **连接：** 带有箭头标记的曲线（贝塞尔），按类型设置样式
- **图层组织：** 按 Y 位置带对节点分组（例如，y: 30-80 = 客户端，y: 130-180 = 服务器）
- **点击评论：** 点击节点 → 打开模态框 → 保存评论 → 节点获得视觉指示器
- **过滤：** 按图层切换节点可见性，按类型切换连接

```javascript
const nodes = [
  { id: 'api-client', label: 'API Client', subtitle: 'src/api/client.ts',
    x: 100, y: 50, w: 140, h: 45, layer: 'client', color: '#dbeafe' },
  // ...
];

const connections = [
  { from: 'api-client', to: 'server', type: 'data-flow', label: 'HTTP' },
  { from: 'server', to: 'db', type: 'data-flow' },
  // ...
];

function renderDiagram() {
  const visibleNodes = nodes.filter(n => state.layers[n.layer]);
  // 先绘制连接（节点下方），然后绘制节点
  connections.forEach(c => drawConnection(c));
  visibleNodes.forEach(n => drawNode(n));
}
```

## 连接类型和样式

定义 3-5 种连接类型，具有不同的视觉样式：

| 类型 | 颜色 | 样式 | 用于 |
|---|---|---|---|
| `data-flow` | 蓝色 (#3b82f6) | 实线 | 请求/响应、数据传递 |
| `tool-call` | 绿色 (#10b981) | 虚线 (6,3) | 函数调用、API 调用 |
| `event` | 红色 (#ef4444) | 短虚线 (4,4) | 异步事件、发布/订阅 |
| `skill-invoke` | 橙色 (#f97316) | 长虚线 (8,4) | 插件/技能激活 |
| `dependency` | 灰色 (#6b7280) | 点线 | 导入/require 关系 |

使用 SVG 标记作为箭头：

```html
<marker id="arrowhead-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
  <polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/>
</marker>
```

## 评论系统

代码地图的关键区别在于点击评论功能：

1. **点击节点** → 打开带有组件名称、文件路径、文本区域的模态框
2. **保存评论** → 添加到评论列表，用视觉指示器（彩色边框）标记节点
3. **查看评论** → 侧边栏列表，显示组件名称、评论预览、删除按钮
4. **删除评论** → 从列表中删除，更新节点视觉，重新生成提示词

评论应包含组件上下文：

```javascript
state.comments.push({
  id: Date.now(),
  target: node.id,
  targetLabel: node.label,
  targetFile: node.subtitle,
  text: userInput
});
```

## 代码地图的提示词输出

提示词结合系统上下文和用户评论：

```
这是 [项目名称] 架构，专注于 [可见图层]。

对特定组件的反馈：

**API Client** (src/api/client.ts):
我想在这里添加指数退避的重试逻辑。

**Database Manager** (src/db/manager.ts):
我们可以添加连接池吗？当前实现为每个请求创建新连接。

**Auth Middleware** (src/middleware/auth.ts):
这应该验证 JWT 令牌并提取用户上下文。
```

仅包含用户添加的评论。如果未显示完整系统，请提及哪些图层可见。

## 使用真实数据预填充

对于特定代码库，预填充以下内容：

- **节点：** 15-25 个关键组件，带有真实文件路径
- **连接：** 20-40 条基于实际导入/调用的关系
- **图层：** 逻辑分组（UI、API、业务逻辑、数据、外部）
- **预设：** "完整系统"、"仅前端"、"仅后端"、"数据流"

按图层将节点组织在水平带中，保持一致的间距。

## 图层调色板（浅色主题）

| 图层 | 节点填充 | 描述 |
|---|---|---|
| 客户端/UI | #dbeafe (blue-100) | React 组件、hooks、页面 |
| 服务器/API | #fef3c7 (amber-100) | Express 路由、中间件、处理程序 |
| SDK/核心 | #f3e8ff (purple-100) | 核心库、SDK 包装器 |
| 代理/逻辑 | #dcfce7 (green-100) | 业务逻辑、代理、处理器 |
| 数据 | #fce7f3 (pink-100) | 数据库、缓存、存储 |
| 外部 | #fbcfe8 (pink-200) | 第三方服务、API |

## 示例主题

- 代码库架构探索器（模块、导入、数据流）
- 微服务地图（服务、队列、数据库、API 网关）
- React 组件树（组件、hooks、上下文、状态）
- API 架构（路由、中间件、控制器、模型）
- 代理系统（提示词、工具、技能、子代理）
- 数据管道（源、转换、接收器、调度）
- 插件/扩展架构（核心、插件、hooks、事件）
