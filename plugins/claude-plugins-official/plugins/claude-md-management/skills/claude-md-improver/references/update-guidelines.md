# CLAUDE.md 更新指南

## 核心原则

只添加真正有助于未来 Claude 会话的信息。上下文窗口很宝贵 - 每行都必须证明其价值。

## 应该添加的内容

### 1. 发现的命令/工作流

```markdown
## 构建

`npm run build:prod` - 带优化的完整生产构建
`npm run build:dev` - 快速开发构建（无压缩）
```

原因：节省未来的会话再次发现这些内容。

### 2. 注意事项和非显而易见的模式

```markdown
## 注意事项

- 由于共享数据库状态，测试必须按顺序运行（`--runInBand`）
- `yarn.lock` 具有权威性；如果依赖不匹配则删除 `node_modules`
```

原因：避免重复调试会话。

### 3. 包关系

```markdown
## 依赖

`auth` 模块依赖于先初始化 `crypto`。
在 `src/bootstrap.ts` 中导入顺序很重要。
```

原因：从代码中不明显的架构知识。

### 4. 有效的测试方法

```markdown
## 测试

对于 API 端点：使用 `supertest` 配合 `tests/setup.ts` 中的测试辅助工具
模拟：使用 `tests/factories/` 中的工厂函数（不是内联模拟）
```

原因：建立有效的模式。

### 5. 配置特殊之处

```markdown
## 配置

- `NEXT_PUBLIC_*` 变量必须在构建时设置，而非运行时
- Redis 连接需要 IPv6 的 `?family=0` 后缀
```

原因：环境特定知识。

## 不应该添加的内容

### 1. 明显的代码信息

不好：
```markdown
`UserService` 类处理用户操作。
```

类名已经告诉我们这一点。

### 2. 通用最佳实践

不好：
```markdown
始终为新功能编写测试。
使用有意义的变量名。
```

这是通用建议，而非项目特定建议。

### 3. 一次性修复

不好：
```markdown
我们在提交 abc123 中修复了一个错误，登录按钮不起作用。
```

不会再次发生；使文件混乱。

### 4. 冗长的解释

不好：
```markdown
身份验证系统使用 JWT 令牌。JWT (JSON Web Tokens) 是
一种开放标准 (RFC 7519)，它定义了一种紧凑和自包含的
方式，用于在各方之间安全地传输信息，作为 JSON
对象。在我们的实现中，我们使用 HS256 算法，它...
```

好：
```markdown
身份验证：使用 HS256 的 JWT，令牌在 `Authorization: Bearer <token>` 标头中。
```

## 更新的差异格式

对于每个建议的更改：

### 1. 识别文件

```
文件：./CLAUDE.md
部分：命令（## Architecture 之后的新部分）
```

### 2. 显示更改

```diff
 ## Architecture
 ...

+## 命令
+
+| 命令 | 用途 |
+|---------|---------|
+| `npm run dev` | 带有 HMR 的开发服务器 |
+| `npm run build` | 生产构建 |
+| `npm test` | 运行测试套件 |
```

### 3. 解释原因

> **为何有帮助：** 构建命令没有记录，导致对如何运行项目感到困惑。
> 这节省了未来的会话需要检查 `package.json`。

## 验证检查清单

在完成更新之前，验证：

- [ ] 每个添加都是项目特定的
- [ ] 没有通用建议或明显信息
- [ ] 命令已测试并可工作
- [ ] 文件路径准确
- [ ] 新的 Claude 会话会发现这有帮助吗？
- [ ] 这是最简洁的表达信息的方式吗？
